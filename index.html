<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Sniper Game</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Start screen styles - transparent overlay over battlefield */
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            font-family: 'Arial', sans-serif;
            color: white;
        }

        #startScreen.hidden {
            display: none;
        }

        .title {
            font-size: 3.5rem;
            font-weight: bold;
            color: #00ff00;
            text-shadow: 0 0 15px #00ff00, 0 0 30px #00ff00, 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 1rem;
            text-align: center;
            animation: pulse 2s infinite;
            letter-spacing: 3px;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #e8e8e8;
            margin-bottom: 3rem;
            text-align: center;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.3), 2px 2px 4px rgba(0, 0, 0, 0.8);
            font-weight: normal;
        }

        .start-button {
            padding: 15px 35px;
            font-size: 1.5rem;
            font-weight: normal;
            background: rgba(20, 25, 30, 0.9);
            color: #e8e8e8;
            border: 2px solid #555;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            backdrop-filter: blur(5px);
            min-width: 200px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
        }

        .start-button:hover {
            background: rgba(30, 35, 40, 0.9);
            border-color: #777;
            color: #00ff00;
            text-shadow: 0 0 8px #00ff00;
        }

        .mayhem-stats {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(20, 25, 30, 0.85);
            padding: 6px 12px;
            border-radius: 4px;
            border: 1px solid #555;
            font-size: 13px;
            backdrop-filter: blur(3px);
            color: #e8e8e8;
            font-family: Arial, sans-serif;
            font-weight: normal;
        }

        .mayhem-stats div {
            margin: 5px 0;
            color: #e8e8e8;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        #startLoading {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.2rem;
            color: #00ff00;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Start Screen (shows first) -->
    <div id="startScreen">
        <div id="startLoading">Loading AI Mayhem...</div>
        
        <div id="startContent" style="display: none;">
            <h1 class="title">SNIPER</h1>
            <button class="start-button" onclick="startMainGame()">START MISSION</button>
        </div>

    </div>

    <!-- Main Game (hidden initially) -->
    <div id="gameContainer">
        <div id="hud">
            <div id="score">Score: <span id="scoreValue">0</span></div>
            <div id="ammo">Ammo: <span id="ammoValue">15</span></div>
            <div id="magazines">Mags: <span id="magazinesValue">3</span></div>
            <div id="health">Health: <span id="healthValue">100</span>/100</div>
            <div id="kills">Kills: <span id="killsValue">0</span></div>
            <div id="timer">Time: <span id="timeValue">60</span>s</div>
        </div>
        <div id="crosshair"></div>
        <div id="hipCrosshair"></div>
        <div id="gameOver" class="hidden">
            <h2>Mission Complete!</h2>
            <p>Final Score: <span id="finalScore">0</span></p>
            <p>Targets Eliminated: <span id="targetsKilled">0</span></p>
            <button id="restartBtn">New Mission</button>
        </div>
        <div id="loading">Loading 3D Environment...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="ai_autonomous.js"></script>
    
    <script>
        // Global variables
        let startScene, startCamera, startRenderer;
        let gameStarted = false;
        let mayhemActive = false;
        let aiStats = {
            unitCount: 0,
            formationCount: 0,
            shotCount: 0,
            casualtyCount: 0
        };

        // Initialize start screen with AI mayhem
        function initStartScreen() {
            // Create 3D scene for background mayhem
            startScene = new THREE.Scene();
            startScene.fog = new THREE.Fog(0x001122, 50, 200);

            // Bird's eye camera
            startCamera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            startCamera.position.set(0, 80, 0);
            startCamera.lookAt(0, 0, 0);

            // Create renderer for battlefield background
            startRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            startRenderer.setSize(window.innerWidth, window.innerHeight);
            startRenderer.setClearColor(0x001122, 1.0);
            startRenderer.shadowMap.enabled = true;
            startRenderer.shadowMap.type = THREE.PCFSoftShadowMap;
            startRenderer.domElement.style.position = 'fixed';
            startRenderer.domElement.style.top = '0';
            startRenderer.domElement.style.left = '0';
            startRenderer.domElement.style.zIndex = '1';
            document.body.insertBefore(startRenderer.domElement, document.body.firstChild);

            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
            startScene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            startScene.add(directionalLight);

            // Create battlefield
            createBattlefield();

            // Set up AI globals for start screen
            window.scene = startScene;
            window.camera = startCamera;
            window.targets = [];
            window.simpleBullets = [];

            // Initialize AI system
            if (window.AI) {
                window.AI.formations = [];
                window.AI.formationId = 0;
                window.AI.lastSpawn = 0;
                window.AI.formationCount = 0;
            }

            // Start mayhem and show content
            setTimeout(() => {
                startAIMayhem();
                document.getElementById('startLoading').style.display = 'none';
                document.getElementById('startContent').style.display = 'block';
                document.getElementById('mayhemStats').style.display = 'block';
                document.getElementById('mayhemIndicator').style.display = 'block';
            }, 1000);

            // Start animation loop
            animateStartScreen();
        }

        function createBattlefield() {
            // Ground
            const groundGeometry = new THREE.PlaneGeometry(300, 300);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x2d4a2b });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            startScene.add(ground);

            // Add more visible terrain features
            for (let i = 0; i < 30; i++) {
                const rockGeometry = new THREE.BoxGeometry(2 + Math.random() * 4, 1 + Math.random() * 3, 2 + Math.random() * 4);
                const rockMaterial = new THREE.MeshLambertMaterial({ color: 0x444444 });
                const rock = new THREE.Mesh(rockGeometry, rockMaterial);
                rock.position.set((Math.random() - 0.5) * 250, rock.geometry.parameters.height / 2, (Math.random() - 0.5) * 250);
                rock.castShadow = true;
                rock.receiveShadow = true;
                startScene.add(rock);
            }

            // Add trees for cover
            for (let i = 0; i < 20; i++) {
                const treeGroup = new THREE.Group();
                
                // Trunk
                const trunkGeometry = new THREE.CylinderGeometry(0.4, 0.6, 5);
                const trunkMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
                const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
                trunk.position.y = 2.5;
                trunk.castShadow = true;
                treeGroup.add(trunk);
                
                // Leaves
                const leavesGeometry = new THREE.SphereGeometry(3, 8, 6);
                const leavesMaterial = new THREE.MeshLambertMaterial({ color: 0x228B22 });
                const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
                leaves.position.y = 6;
                leaves.castShadow = true;
                treeGroup.add(leaves);
                
                treeGroup.position.set(
                    (Math.random() - 0.5) * 200,
                    0,
                    (Math.random() - 0.5) * 200
                );
                startScene.add(treeGroup);
            }
        }

        function startAIMayhem() {
            mayhemActive = true;
            
            // Spawn AI formations
            if (window.AI && window.AI.spawnFormation) {
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        window.AI.spawnFormation();
                        aiStats.formationCount++;
                        updateMayhemStats();
                    }, i * 1000);
                }

                setInterval(() => {
                    if (window.targets.length < 20 && mayhemActive) {
                        window.AI.spawnFormation();
                        aiStats.formationCount++;
                        updateMayhemStats();
                    }
                }, 3000);
            }

            // Make AI fight each other
            setInterval(() => {
                if (mayhemActive) makeAIFightEachOther();
            }, 100);
        }

        function makeAIFightEachOther() {
            if (!window.targets || window.targets.length < 2) return;

            window.targets.forEach(enemy => {
                if (!enemy.userData) return;

                let nearestEnemy = null;
                let nearestDistance = Infinity;

                window.targets.forEach(otherEnemy => {
                    if (otherEnemy === enemy || !otherEnemy.userData) return;
                    const distance = enemy.position.distanceTo(otherEnemy.position);
                    if (distance < nearestDistance && distance < 50) {
                        nearestDistance = distance;
                        nearestEnemy = otherEnemy;
                    }
                });

                if (nearestEnemy) {
                    enemy.userData.isAlerted = true;
                    enemy.userData.isHunting = true;
                    enemy.userData.lastPlayerSeen = Date.now();
                    if (enemy.children[0]) {
                        enemy.children[0].material.color.setHex(0xff4444);
                    }
                }
            });

            aiStats.unitCount = window.targets.length;
            aiStats.shotCount += Math.floor(Math.random() * 3);
            updateMayhemStats();
        }

        function updateMayhemStats() {
            document.getElementById('aiCount').textContent = aiStats.unitCount;
            document.getElementById('formationCount').textContent = aiStats.formationCount;
            document.getElementById('shotCount').textContent = aiStats.shotCount;
            document.getElementById('casualtyCount').textContent = aiStats.casualtyCount;
        }

        function animateStartScreen() {
            if (!gameStarted) {
                requestAnimationFrame(animateStartScreen);

                if (window.AI && window.AI.updateEnemyAI && mayhemActive) {
                    window.AI.updateEnemyAI();
                }

                // Rotate camera for dynamic view
                const time = Date.now() * 0.0005;
                startCamera.position.x = Math.cos(time) * 20;
                startCamera.position.z = Math.sin(time) * 20;
                startCamera.lookAt(0, 0, 0);

                startRenderer.render(startScene, startCamera);
            }
        }

        function startMainGame() {
            gameStarted = true;
            mayhemActive = false;

            // Hide start screen
            document.getElementById('startScreen').classList.add('hidden');
            
            // Remove start screen renderer
            if (startRenderer && startRenderer.domElement) {
                document.body.removeChild(startRenderer.domElement);
            }

            // Clear start screen objects
            window.targets = [];
            window.simpleBullets = [];
            
            // Load main game script
            const gameScript = document.createElement('script');
            gameScript.src = 'tower3d.js';
            gameScript.onload = () => {
                console.log('Main game loaded and started!');
            };
            document.head.appendChild(gameScript);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (startCamera && startRenderer) {
                startCamera.aspect = window.innerWidth / window.innerHeight;
                startCamera.updateProjectionMatrix();
                startRenderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // Initialize start screen when page loads
        window.addEventListener('load', initStartScreen);
    </script>
</body>
</html>
